#include <windows.h>
#include <bluetoothapis.h>
#include <stdio.h>

#pragma comment(lib, "bthprops.lib")

int main() {
    BLUETOOTH_DEVICE_SEARCH_PARAMS searchParams = { 0 };
    BLUETOOTH_DEVICE_INFO deviceInfo = { 0 };
    HBLUETOOTH_DEVICE_FIND hFind = NULL;

    searchParams.dwSize = sizeof(BLUETOOTH_DEVICE_SEARCH_PARAMS);
    searchParams.fReturnAuthenticated = TRUE;
    searchParams.fReturnRemembered = TRUE;
    searchParams.fReturnUnknown = TRUE;
    searchParams.fReturnConnected = TRUE;
    searchParams.fIssueInquiry = TRUE;
    searchParams.cTimeoutMultiplier = 2;
    searchParams.hRadio = NULL;

    deviceInfo.dwSize = sizeof(BLUETOOTH_DEVICE_INFO);

    hFind = BluetoothFindFirstDevice(&searchParams, &deviceInfo);
    if (hFind == NULL) {
        printf("No Bluetooth devices found or Bluetooth is off.\n");
        return 1;
    }

    do {
        wprintf(L"Found device: %s\n", deviceInfo.szName);
        printf("Address: %02X:%02X:%02X:%02X:%02X:%02X\n",
            deviceInfo.Address.rgBytes[5],
            deviceInfo.Address.rgBytes[4],
            deviceInfo.Address.rgBytes[3],
            deviceInfo.Address.rgBytes[2],
            deviceInfo.Address.rgBytes[1],
            deviceInfo.Address.rgBytes[0]);
    } while (BluetoothFindNextDevice(hFind, &deviceInfo));

    BluetoothFindDeviceClose(hFind);
    return 0;
}
